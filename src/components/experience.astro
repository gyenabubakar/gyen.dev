---
import experience from '~/data/experience.json';
import { ChevronDownIcon } from '@lucide/astro';
import { Image } from 'astro:assets';
import walulel from '~/assets/companies/walulel.png';
import sourcertz from '~/assets/companies/sourcertz.png';
import plugdrive from '~/assets/companies/plugdrive.png';
import amev from '~/assets/companies/amev.svg';
import distro from '~/assets/companies/distro.svg';
import distroLight from '~/assets/companies/distro-light.svg';
import lbm from '~/assets/companies/lbm.svg';
import specta from '~/assets/companies/specta.svg';

const imageMap: Record<string, ImageMetadata> = {
  'walulel.png': walulel,
  'sourcertz.png': sourcertz,
  'plugdrive.png': plugdrive,
  'amev.svg': amev,
  'distro.svg': distro,
  'distro-light.svg': distroLight,
  'lbm.svg': lbm,
  'specta.svg': specta,
};
---

<section class="mb-16">
  <h2 class="mb-8 text-2xl font-bold">Experience</h2>

  <div class="space-y-8">
    {
      experience.map((job, index) => (
        <article class="experience-item transform">
          <div class="flex items-start justify-between gap-4">
            <div class="flex flex-1 items-start gap-3">
              <div class="hidden sm:block [&>img]:size-12 [&>img]:object-contain">
                {job.logoDark && imageMap[job.logoDark] ? (
                  <>
                    <Image
                      src={imageMap[job.logo]}
                      alt={job.company}
                      class="dark:hidden"
                      width={48}
                      height={48}
                    />
                    <Image
                      src={imageMap[job.logoDark]}
                      alt={job.company}
                      class="hidden dark:block"
                      width={48}
                      height={48}
                    />
                  </>
                ) : imageMap[job.logo] ? (
                  <Image
                    src={imageMap[job.logo]}
                    alt={job.company}
                    class=""
                    width={48}
                    height={48}
                  />
                ) : (
                  <img
                    src={`/companies/${job.logo}`}
                    alt={job.company}
                    class=""
                    width="48"
                    height="48"
                  />
                )}
              </div>

              <div class="flex-1">
                <div class="mb-2 sm:hidden [&>img]:size-12 [&>img]:object-contain">
                  {job.logoDark && imageMap[job.logoDark] ? (
                    <>
                      <Image
                        src={imageMap[job.logo]}
                        alt={job.company}
                        class="dark:hidden"
                        width={48}
                        height={48}
                      />
                      <Image
                        src={imageMap[job.logoDark]}
                        alt={job.company}
                        class="hidden dark:block"
                        width={48}
                        height={48}
                      />
                    </>
                  ) : imageMap[job.logo] ? (
                    <Image
                      src={imageMap[job.logo]}
                      alt={job.company}
                      class=""
                      width={48}
                      height={48}
                    />
                  ) : (
                    <img
                      src={`/companies/${job.logo}`}
                      alt={job.company}
                      class=""
                      width="48"
                      height="48"
                    />
                  )}
                </div>

                <h3 class="text-xl font-medium">{job.company}</h3>

                <p class="text-[15px]">
                  {job.role} Â· {job.startDate} - {job.endDate ?? 'Present'}
                </p>
              </div>
            </div>

            <button
              class="toggle-btn flex size-8 items-center justify-center rounded-full border border-black transition-colors duration-500 hover:bg-black hover:text-white dark:border-white dark:hover:bg-white dark:hover:text-black"
              data-index={index}
              aria-label="Toggle description"
              aria-expanded="false"
            >
              <ChevronDownIcon size={16} class="chevron transition-transform duration-300" />
            </button>
          </div>

          <div class="description-wrapper max-h-0 overflow-hidden transition-all duration-300">
            <p class="pt-2 text-sm leading-relaxed text-neutral-600 sm:ml-[52px] dark:text-neutral-400">
              {job.description}
            </p>
          </div>
        </article>
      ))
    }
  </div>
</section>

<script>
  document.querySelectorAll('.toggle-btn').forEach((btn) => {
    const toggleBtn = btn as HTMLElement;

    toggleBtn.addEventListener('click', () => {
      const article = toggleBtn.closest('.experience-item');
      const wrapper = article?.querySelector('.description-wrapper') as HTMLElement;
      const chevron = toggleBtn.querySelector('.chevron') as HTMLElement;

      if (wrapper && chevron) {
        const isOpen = wrapper.style.maxHeight && wrapper.style.maxHeight !== '0px';

        if (isOpen) {
          wrapper.style.maxHeight = '0';
          chevron.style.transform = 'rotate(0deg)';
          toggleBtn.setAttribute('aria-expanded', 'false');
        } else {
          wrapper.style.maxHeight = wrapper.scrollHeight + 'px';
          chevron.style.transform = 'rotate(180deg)';
          toggleBtn.setAttribute('aria-expanded', 'true');
        }
      }
    });
  });
</script>
